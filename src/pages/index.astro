---
import '../styles/global.css';
const base = import.meta.env.BASE_URL;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href={`${base}tss-logo.svg`} />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content={Astro.generator} />
    <title>Twin Spruce Studio — Josh Stubbington</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700;900&display=swap"
      rel="stylesheet"
    />
  </head>

  <body
    style={`background-image: url('${base}bg.jpg'); background-size: cover; background-position: center; background-attachment: fixed; min-height: 100vh; margin: 0; padding: 70px 0; display: flex; flex-direction: column; align-items: center;`}
  >
    <!-- Dark card -->
    <div
      class="relative overflow-hidden mx-auto rounded-[70px]"
      style="width: 100%; max-width: 1294px; min-height: 883px;"
    >
      <!-- Background gradient fill -->
      <div
        class="absolute inset-0"
        style="background: linear-gradient(135deg, #1e1b18 0%, rgba(0,0,0,0.88) 100%);"
      ></div>

      <!-- Lava lamp blobs (z=1) -->
      <div class="absolute inset-0 pointer-events-none overflow-hidden" style="z-index: 1;">
        <div
          class="animate-blob absolute rounded-full [filter:blur(50px)] [animation-duration:11s]"
          style="width:280px; height:280px; left:8%; top:20%; background:radial-gradient(circle, rgba(124,58,237,0.7), transparent 70%);"
        ></div>
        <div
          class="animate-blob absolute rounded-full [filter:blur(55px)] [animation-duration:14s] [animation-delay:-4s]"
          style="width:240px; height:240px; left:38%; top:45%; background:radial-gradient(circle, rgba(8,145,178,0.6), transparent 70%);"
        ></div>
        <div
          class="animate-blob absolute rounded-full [filter:blur(50px)] [animation-duration:12s] [animation-delay:-7s]"
          style="width:260px; height:260px; left:18%; top:60%; background:radial-gradient(circle, rgba(219,49,91,0.55), transparent 70%);"
        ></div>
        <div
          class="animate-blob absolute rounded-full [filter:blur(55px)] [animation-duration:15s] [animation-delay:-10s]"
          style="width:200px; height:200px; left:55%; top:15%; background:radial-gradient(circle, rgba(5,150,105,0.55), transparent 70%);"
        ></div>
        <div
          class="animate-blob absolute rounded-full [filter:blur(50px)] [animation-duration:10s] [animation-delay:-5s]"
          style="width:220px; height:220px; left:5%; top:75%; background:radial-gradient(circle, rgba(234,88,12,0.5), transparent 70%);"
        ></div>
      </div>

      <!-- TSS Logo (z=2, sits behind tiles) -->
      <img
        src={`${base}tss-logo.svg`}
        width="66"
        height="143"
        alt="Twin Spruce Studio logo"
        class="absolute"
        style="left: 58px; top: 82px; z-index: 2;"
      />

      <!-- TWIN SPRUCE STUDIO heading (z=2, partially behind middle/right tiles) -->
      <div
        class="absolute font-black"
        style="left: 152px; top: 73px; font-size: 68px; line-height: 1; letter-spacing: 0.08em; z-index: 2; white-space: nowrap; color: #fffaff;"
      >
        TWIN SPRUCE STUDIO
      </div>

      <!-- Content (z=10) — three columns -->
      <div
        class="relative grid z-10 gap-5"
        style="padding: 43px 42px 34px 34px; grid-template-columns: 1fr 311px 215px;"
      >
        <!-- ─── LEFT COLUMN ─── -->
        <div class="flex flex-col" style="min-height: 806px;">
          <!-- Three.js morphing geometry -->
          <div id="three-canvas" class="flex-1 w-full min-h-0 rounded-[20px] overflow-hidden mt-[95px]"></div>
          <!-- Profile card at bottom -->
          <div class="flex items-center gap-4 mt-6">
            <img
              src={`${base}profile.png`}
              alt="Josh Stubbington"
              class="shrink-0 rounded-full object-cover"
              style="width: 80px; height: 80px;"
            />
            <div>
              <p class="font-bold" style="font-size: 36px; line-height: 1; color: #fffaff;">
                JOSH STUBBINGTON
              </p>
              <p class="text-sm mt-1" style="color: rgba(255,250,255,0.6);">
                Full Stack Developer &middot; Ottawa, ON
              </p>
            </div>
          </div>
        </div>

        <!-- ─── MIDDLE COLUMN ─── -->
        <div class="flex flex-col gap-4">
          <!-- Welcome tile (h=179) -->
          <div class="tile rounded-[15px] p-5 flex flex-col transition-transform duration-200 hover:scale-[1.02]" style="height: 179px; --tile-gradient-dir: to top;">
            <p class="font-bold text-2xl mb-3" style="color: #fffaff;">Welcome!</p>
            <p class="text-sm leading-relaxed" style="color: rgba(255,250,255,0.65);">
              I'm a full-stack developer and designer building thoughtful digital
              experiences — from concept through deployment.
            </p>
          </div>

          <!-- MY STACK tile -->
          <div class="tile rounded-[15px] p-5 flex flex-col flex-1 transition-transform duration-200 hover:scale-[1.02]" style="--tile-gradient-dir: to bottom left;">
            <p class="font-bold text-2xl mb-4" style="color: #fffaff;">MY STACK</p>
            <div class="flex flex-col gap-2 flex-1">
              <div
                class="h-11 rounded-xl flex items-center px-3 bg-white/[.08] hover:bg-white/[.14] hover:scale-[1.02] transition-all duration-150 cursor-default"
              >
                <span class="text-sm" style="color: rgba(255,250,255,0.7);"
                  >Backend: Ruby on Rails, Go, C++</span
                >
              </div>
              <div
                class="h-11 rounded-xl flex items-center px-3 bg-white/[.08] hover:bg-white/[.14] hover:scale-[1.02] transition-all duration-150 cursor-default"
              >
                <span class="text-sm" style="color: rgba(255,250,255,0.7);"
                  >Frontend: JavaScript, Angular, React</span
                >
              </div>
              <div
                class="h-11 rounded-xl flex items-center px-3 bg-white/[.08] hover:bg-white/[.14] hover:scale-[1.02] transition-all duration-150 cursor-default"
              >
                <span class="text-sm" style="color: rgba(255,250,255,0.7);"
                  >Database: PostgreSQL, Redis, MongoDB</span
                >
              </div>
              <div
                class="h-11 rounded-xl flex items-center px-3 bg-white/[.08] hover:bg-white/[.14] hover:scale-[1.02] transition-all duration-150 cursor-default"
              >
                <span class="text-sm" style="color: rgba(255,250,255,0.7);"
                  >Tools: Docker, Jenkins, .NET (C#)</span
                >
              </div>
            </div>
            <button
              class="view-more-btn mt-3 w-full flex items-center justify-center gap-1.5 rounded-[5px] transition-all duration-150 hover:scale-[1.02] hover:shadow-[0_0_14px_rgba(62,146,204,0.5)]"
              style="height: 21px; font-size: 12px; font-weight: 400; color: #3e92cc; background: rgba(64,86,244,0.2); border: 1px solid #3e92cc;"
            >
              + View More
            </button>
          </div>

          <!-- FOLLOW ME tile (h=109) -->
          <div
            class="tile rounded-[15px] p-5 flex flex-col justify-between transition-transform duration-200 hover:scale-[1.02]"
            style="height: 109px; --tile-gradient-dir: to bottom;"
          >
            <p class="font-bold text-xl" style="color: #fffaff;">FOLLOW ME</p>
            <div class="flex gap-5 items-center">
              <!-- GitHub -->
              <a
                href="https://github.com/ayfor"
                target="_blank"
                rel="noopener noreferrer"
                class="transition-transform duration-150 hover:scale-110"
                style="color: rgba(255,250,255,0.8); transition: color 0.2s;"
                onmouseover="this.style.color='#fffaff'"
                onmouseout="this.style.color='rgba(255,250,255,0.8)'"
                aria-label="GitHub"
              >
                <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                  <path
                    d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0 0 24 12c0-6.63-5.37-12-12-12z"
                  ></path>
                </svg>
              </a>
              <!-- X / Twitter -->
              <a
                href="https://x.com/ayfor"
                target="_blank"
                rel="noopener noreferrer"
                class="transition-transform duration-150 hover:scale-110"
                style="color: rgba(255,250,255,0.8); transition: color 0.2s;"
                onmouseover="this.style.color='#fffaff'"
                onmouseout="this.style.color='rgba(255,250,255,0.8)'"
                aria-label="X (Twitter)"
              >
                <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                  <path
                    d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-4.714-6.231-5.401 6.231H2.744l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"
                  ></path>
                </svg>
              </a>
              <!-- LinkedIn -->
              <a
                href="https://linkedin.com/in/joshstubbington"
                target="_blank"
                rel="noopener noreferrer"
                class="transition-transform duration-150 hover:scale-110"
                style="color: rgba(255,250,255,0.8); transition: color 0.2s;"
                onmouseover="this.style.color='#fffaff'"
                onmouseout="this.style.color='rgba(255,250,255,0.8)'"
                aria-label="LinkedIn"
              >
                <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                  <path
                    d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"
                  ></path>
                </svg>
              </a>
              <!-- Gumroad -->
              <a
                href="https://app.gumroad.com/ayfor"
                target="_blank"
                rel="noopener noreferrer"
                class="transition-transform duration-150 hover:scale-110"
                style="color: rgba(255,250,255,0.8); transition: color 0.2s;"
                onmouseover="this.style.color='#fffaff'"
                onmouseout="this.style.color='rgba(255,250,255,0.8)'"
                aria-label="Gumroad"
              >
                <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                  <path
                    d="M12 0C5.372 0 0 5.372 0 12s5.372 12 12 12 12-5.372 12-12S18.628 0 12 0zm5.82 14.43a6.48 6.48 0 0 1-6.487 5.783 6.48 6.48 0 0 1-6.48-6.481A6.48 6.48 0 0 1 11.333 7.25h4.38v2.56h-4.38c-2.168 0-3.922 1.754-3.922 3.923s1.754 3.921 3.922 3.921c1.782 0 3.28-1.187 3.769-2.814H12V12.28h5.82v2.15z"
                  ></path>
                </svg>
              </a>
            </div>
          </div>

          <!-- Download Resume button (h=74) -->
          <a
            href={`${base}resume.pdf`}
            class="spotlight relative overflow-hidden flex items-center justify-center font-black text-xl shrink-0 mt-auto transition-transform duration-200 hover:scale-[1.03]"
            style="height: 74px; background: #3e92cc; color: #fffaff; border-radius: 10px 10px 10px 60px; text-decoration: none;"
          >
            Download Resume
          </a>
        </div>

        <!-- ─── RIGHT COLUMN ─── -->
        <div class="flex flex-col gap-3">
          <!-- ALL PROJECTS tile (h=215) -->
          <a
            href="#"
            class="tile rounded-[10px] flex flex-col items-center justify-center transition-transform duration-200 hover:scale-[1.02]"
            style="flex: 215 1 0%; text-decoration: none; --tile-gradient-dir: to top right;"
          >
            <span style="font-size: 80px; line-height: 1; color: #fffaff; font-weight: 300;">↗</span>
            <p
              class="font-black text-xs mt-2"
              style="color: #fffaff; letter-spacing: 0.18em;"
            >
              ALL PROJECTS
            </p>
          </a>

          <!-- Recent Projects tile (h=258) -->
          <div class="tile rounded-[15px] p-4 flex flex-col transition-transform duration-200 hover:scale-[1.02]" style="flex: 258 1 0%; --tile-gradient-dir: to right;">
            <p class="font-bold text-lg mb-3" style="color: #fffaff;">Recent Projects</p>
            <div class="flex flex-col gap-2 flex-1">
              <div
                class="rounded-lg flex items-center px-3 bg-white/[.08] hover:bg-white/[.14] hover:scale-[1.02] transition-all duration-150 cursor-default"
                style="height: 48px;"
              >
                <span class="text-xs" style="color: rgba(255,250,255,0.65);">TSS Portfolio v3</span>
              </div>
              <div
                class="rounded-lg flex items-center px-3 bg-white/[.08] hover:bg-white/[.14] hover:scale-[1.02] transition-all duration-150 cursor-default"
                style="height: 48px;"
              >
                <span class="text-xs" style="color: rgba(255,250,255,0.65);">Project Two</span>
              </div>
              <div
                class="rounded-lg flex items-center px-3 bg-white/[.08] hover:bg-white/[.14] hover:scale-[1.02] transition-all duration-150 cursor-default"
                style="height: 48px;"
              >
                <span class="text-xs" style="color: rgba(255,250,255,0.65);">Project Three</span>
              </div>
            </div>
          </div>

          <!-- Other Work tile (h=232) -->
          <div class="tile rounded-[15px] p-4 flex flex-col transition-transform duration-200 hover:scale-[1.02]" style="flex: 232 1 0%; --tile-gradient-dir: to bottom right;">
            <p class="font-bold text-lg mb-3" style="color: #fffaff;">Other Work</p>
            <div class="flex flex-col gap-2 flex-1">
              <div
                class="rounded-lg flex items-center px-3 bg-white/[.08] hover:bg-white/[.14] hover:scale-[1.02] transition-all duration-150 cursor-default"
                style="height: 48px;"
              >
                <span class="text-xs" style="color: rgba(255,250,255,0.65);">Freelance Design</span>
              </div>
              <div
                class="rounded-lg flex items-center px-3 bg-white/[.08] hover:bg-white/[.14] hover:scale-[1.02] transition-all duration-150 cursor-default"
                style="height: 48px;"
              >
                <span class="text-xs" style="color: rgba(255,250,255,0.65);">Open Source</span>
              </div>
              <div
                class="rounded-lg flex items-center px-3 bg-white/[.08] hover:bg-white/[.14] hover:scale-[1.02] transition-all duration-150 cursor-default"
                style="height: 48px;"
              >
                <span class="text-xs" style="color: rgba(255,250,255,0.65);">Photography</span>
              </div>
            </div>
          </div>

          <!-- Contact Me button -->
          <a
            href="mailto:hello@twinssprucestudio.com"
            class="spotlight relative overflow-hidden flex items-center justify-center font-black text-xl shrink-0 mt-auto transition-transform duration-200 hover:scale-[1.03]"
            style="height: 74px; background: #d8315b; color: #fffaff; border-radius: 10px 10px 60px 10px; text-decoration: none;"
          >
            Contact Me
          </a>
        </div>
      </div>
    </div>
    <script>
      import * as THREE from 'three';
      import { createNoise3D } from 'simplex-noise';

      const noise3D = createNoise3D();
      const container = document.getElementById('three-canvas');

      // ── Renderer ──────────────────────────────────────────────────────────
      const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      renderer.setClearColor(0x000000, 0);
      renderer.domElement.style.cssText = 'display:block;width:100%;height:100%;';
      container.appendChild(renderer.domElement);

      // ── Scene & Camera ────────────────────────────────────────────────────
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(52, 1, 0.1, 50);
      camera.position.z = 5.0;

      // ── Palette (matches lava blobs) ──────────────────────────────────────
      const PALETTE = [
        new THREE.Color(0x7c3aed), // purple
        new THREE.Color(0x0891b2), // cyan
        new THREE.Color(0xdb315b), // pink
        new THREE.Color(0x059669), // green
        new THREE.Color(0xea580c), // orange
      ];

      // ── Geometry ──────────────────────────────────────────────────────────
      const geo = new THREE.IcosahedronGeometry(1, 4);
      const posAttr = geo.attributes.position;
      const N = posAttr.count;

      // Snapshot original unit-sphere positions
      const base = new Float32Array(N * 3);
      for (let i = 0; i < N; i++) {
        base[i*3]   = posAttr.getX(i);
        base[i*3+1] = posAttr.getY(i);
        base[i*3+2] = posAttr.getZ(i);
      }

      // ── Pine tree target shape ─────────────────────────────────────────────
      // Maps each unit-sphere vertex to a point on a pine tree surface using
      // its azimuthal angle (theta) and latitude (oy) as the guide.
      function pineTreePos(ox, oy, oz) {
        const theta = Math.atan2(oz, ox);
        let tr;

        if (oy > 0.80) {
          // Pointed tip — converges to zero at the top pole
          tr = (1.0 - oy) * 0.12;
        } else if (oy > -0.28) {
          // Crown: three tiered cones
          const h = (oy + 0.28) / 1.08; // 0 = base of crown, 1 = top
          const cone = (1 - h) * 0.58;  // main conical envelope
          // Periodic skirt gives each tier a wider flare at its base
          const withinTier = (h * 3.0) % 1.0;
          const skirt = Math.pow(1 - withinTier, 2) * 0.14;
          tr = cone + skirt;
        } else if (oy > -0.65) {
          // Trunk — thin cylinder
          tr = 0.05;
        } else {
          // Taper to base
          tr = Math.max(0, 0.05 * (1.0 + oy) / 0.35);
        }

        return [Math.cos(theta) * tr, oy, Math.sin(theta) * tr];
      }

      // Precompute tree targets so we avoid trig in the hot loop
      const treeTarget = new Float32Array(N * 3);
      for (let i = 0; i < N; i++) {
        const [tx, ty, tz] = pineTreePos(base[i*3], base[i*3+1], base[i*3+2]);
        treeTarget[i*3]   = tx;
        treeTarget[i*3+1] = ty;
        treeTarget[i*3+2] = tz;
      }

      // ── Mirror tree target shape ───────────────────────────────────────────
      // Reflection of pineTreePos across y=0: maps (ox,oy,oz) → pineTree of
      // (ox,−oy,oz) then negates y, producing a perfect upside-down twin.
      function mirrorTreePos(ox, oy, oz) {
        const [tx, ty, tz] = pineTreePos(ox, -oy, oz);
        return [tx, -ty, tz];
      }

      const mirrorTarget = new Float32Array(N * 3);
      for (let i = 0; i < N; i++) {
        const [tx, ty, tz] = mirrorTreePos(base[i*3], base[i*3+1], base[i*3+2]);
        mirrorTarget[i*3]   = tx;
        mirrorTarget[i*3+1] = ty;
        mirrorTarget[i*3+2] = tz;
      }

      // ── Morph timing ──────────────────────────────────────────────────────
      // Cycle (25s):  blob(0-5) → main-in(5-8) → main-alone(8-9)
      //               → mirror-in(9-12) → both-hold(12-20) → both-out(20-23) → blob(23-25)
      const T_CYCLE = 25;
      function smoothstep(x) { return x * x * (3 - 2 * x); }

      function getMorphT(t) {
        const p = t % T_CYCLE;
        if (p < 5)  return 0;
        if (p < 8)  return smoothstep((p - 5) / 3);
        if (p < 20) return 1;
        if (p < 23) return 1 - smoothstep((p - 20) / 3);
        return 0;
      }

      function getMirrorMorphT(t) {
        const p = t % T_CYCLE;
        if (p < 9)  return 0;
        if (p < 12) return smoothstep((p - 9) / 3);
        if (p < 20) return 1;
        if (p < 23) return 1 - smoothstep((p - 20) / 3);
        return 0;
      }

      // ── Vertex colour attribute ────────────────────────────────────────────
      const colAttr = new THREE.BufferAttribute(new Float32Array(N * 3), 3);
      geo.setAttribute('color', colAttr);

      // ── Solid mesh ────────────────────────────────────────────────────────
      const solidMat = new THREE.MeshPhongMaterial({
        vertexColors: true,
        shininess: 110,
        specular: new THREE.Color(0xffffff).multiplyScalar(0.35),
        transparent: true,
        opacity: 0.90,
      });
      const solid = new THREE.Mesh(geo, solidMat);
      // Wireframe as child of solid — inherits position and rotation automatically
      solid.add(new THREE.Mesh(geo, new THREE.MeshBasicMaterial({
        wireframe: true, color: 0xffffff, transparent: true, opacity: 0.05,
      })));

      // ── Mirror geometry (upside-down twin tree) ───────────────────────────
      const geoMirror = new THREE.IcosahedronGeometry(1, 4);
      const mirrorPosAttr = geoMirror.attributes.position;
      const mirrorColAttr = new THREE.BufferAttribute(new Float32Array(N * 3), 3);
      geoMirror.setAttribute('color', mirrorColAttr);

      // Collapse mirror vertices onto y-axis — will unfold radially during morph
      for (let i = 0; i < N; i++) {
        mirrorPosAttr.setXYZ(i, 0, base[i*3+1], 0);
      }
      mirrorPosAttr.needsUpdate = true;

      const solidMirror = new THREE.Mesh(geoMirror, solidMat);
      solidMirror.visible = false;
      // Wireframe as child of solidMirror — inherits visibility and transform
      solidMirror.add(new THREE.Mesh(geoMirror, new THREE.MeshBasicMaterial({
        wireframe: true, color: 0xffffff, transparent: true, opacity: 0.05,
      })));

      // ── Lighting ──────────────────────────────────────────────────────────
      scene.add(new THREE.AmbientLight(0xffffff, 0.35));
      const orbitLights = [
        new THREE.PointLight(0x7c3aed, 4, 10),
        new THREE.PointLight(0x0891b2, 4, 10),
        new THREE.PointLight(0xea580c, 3, 10),
      ];
      orbitLights.forEach(l => scene.add(l));

      // ── Scene group (both trees rotate together) ──────────────────────────
      const group = new THREE.Group();
      scene.add(group);
      group.add(solid);
      group.add(solidMirror);

      // ── Drag-to-rotate controls ────────────────────────────────────────────
      let isDragging = false;
      let prevMouse = { x: 0, y: 0 };
      let autoRotate = true;
      let dragTimeout;

      renderer.domElement.style.cursor = 'grab';

      renderer.domElement.addEventListener('mousedown', e => {
        isDragging = true;
        autoRotate = false;
        clearTimeout(dragTimeout);
        prevMouse = { x: e.clientX, y: e.clientY };
        renderer.domElement.style.cursor = 'grabbing';
      });
      window.addEventListener('mousemove', e => {
        if (!isDragging) return;
        const dx = e.clientX - prevMouse.x;
        const dy = e.clientY - prevMouse.y;
        group.rotation.y += dx * 0.008;
        group.rotation.x += dy * 0.008;
        group.rotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, group.rotation.x));
        prevMouse = { x: e.clientX, y: e.clientY };
      });
      window.addEventListener('mouseup', () => {
        if (!isDragging) return;
        isDragging = false;
        renderer.domElement.style.cursor = 'grab';
        dragTimeout = setTimeout(() => { autoRotate = true; }, 2000);
      });

      renderer.domElement.addEventListener('touchstart', e => {
        e.preventDefault();
        isDragging = true;
        autoRotate = false;
        clearTimeout(dragTimeout);
        prevMouse = { x: e.touches[0].clientX, y: e.touches[0].clientY };
      }, { passive: false });
      window.addEventListener('touchmove', e => {
        if (!isDragging) return;
        const dx = e.touches[0].clientX - prevMouse.x;
        const dy = e.touches[0].clientY - prevMouse.y;
        group.rotation.y += dx * 0.008;
        group.rotation.x += dy * 0.008;
        group.rotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, group.rotation.x));
        prevMouse = { x: e.touches[0].clientX, y: e.touches[0].clientY };
      }, { passive: false });
      window.addEventListener('touchend', () => {
        isDragging = false;
        dragTimeout = setTimeout(() => { autoRotate = true; }, 2000);
      });

      // ── Helpers ───────────────────────────────────────────────────────────
      const tempCol = new THREE.Color();
      function lerpColor(a, b, f) {
        tempCol.r = a.r + (b.r - a.r) * f;
        tempCol.g = a.g + (b.g - a.g) * f;
        tempCol.b = a.b + (b.b - a.b) * f;
      }

      function sizeRenderer() {
        const w = container.clientWidth;
        const h = container.clientHeight;
        if (!w || !h) return;
        renderer.setSize(w, h);
        camera.aspect = w / h;
        camera.updateProjectionMatrix();
      }

      // ── Animation loop ────────────────────────────────────────────────────
      const clock = new THREE.Clock();

      (function animate() {
        requestAnimationFrame(animate);
        const t = clock.getElapsedTime();
        const morphT = getMorphT(t);

        // Blob noise amplitude — fades out as tree morphs in
        const amp = (0.30 + Math.sin(t * 0.16) * 0.20) * (1 - morphT);

        for (let i = 0; i < N; i++) {
          const ox = base[i*3], oy = base[i*3+1], oz = base[i*3+2];

          // ── Blob position (noise-displaced sphere) ─────────────────────
          const n1 = noise3D(ox * 1.6 + t * 0.22,  oy * 1.6 - t * 0.10, oz * 1.6);
          const n2 = noise3D(ox * 3.2 - t * 0.18,  oy * 3.2,             oz * 3.2 + t * 0.14);
          const n3 = noise3D(ox * 6.4,              oy * 6.4 + t * 0.12, oz * 6.4 - t * 0.09);
          const s  = 1 + n1 * amp + n2 * (amp * 0.5) + n3 * (amp * 0.25);
          const bx = ox * s, by = oy * s, bz = oz * s;

          // ── Pine tree position — with subtle organic noise overlay ──────
          const treeFuzz = noise3D(ox * 5 + t * 0.04, oy * 5, oz * 5) * 0.025 * morphT;
          const tx = treeTarget[i*3]   * (1 + treeFuzz);
          const ty = treeTarget[i*3+1] * (1 + treeFuzz * 0.1);
          const tz = treeTarget[i*3+2] * (1 + treeFuzz);

          // ── Interpolate ────────────────────────────────────────────────
          posAttr.setXYZ(i,
            bx + (tx - bx) * morphT,
            by + (ty - by) * morphT,
            bz + (tz - bz) * morphT,
          );

          // ── Vertex colour ──────────────────────────────────────────────
          const cn  = (noise3D(ox * 0.7 + t * 0.10, oy * 0.7, oz * 0.7 - t * 0.07) + 1) * 0.5;
          const ci  = cn * (PALETTE.length - 1);
          const ci0 = Math.floor(ci);
          const ci1 = Math.min(ci0 + 1, PALETTE.length - 1);
          lerpColor(PALETTE[ci0], PALETTE[ci1], ci - ci0);
          colAttr.setXYZ(i, tempCol.r, tempCol.g, tempCol.b);
        }

        posAttr.needsUpdate = true;
        colAttr.needsUpdate = true;
        geo.computeVertexNormals();

        // ── Mirror tree ────────────────────────────────────────────────────
        const mirrorMorphT = getMirrorMorphT(t);
        solidMirror.visible = mirrorMorphT > 0.001;

        if (solidMirror.visible) {
          for (let i = 0; i < N; i++) {
            const ox = base[i*3], oy = base[i*3+1], oz = base[i*3+2];

            // Unfold radially from y-axis with subtle organic fuzz
            const mFuzz = noise3D(ox * 5 - t * 0.04, oy * 5 + 2.3, oz * 5) * 0.025 * mirrorMorphT;
            mirrorPosAttr.setXYZ(i,
              mirrorTarget[i*3]   * mirrorMorphT * (1 + mFuzz),
              mirrorTarget[i*3+1],
              mirrorTarget[i*3+2] * mirrorMorphT * (1 + mFuzz),
            );

            // Vertex colours with phase offset for visual variety
            const cn = (noise3D(ox * 0.7 + t * 0.10 + 1.7, oy * 0.7, oz * 0.7 - t * 0.07) + 1) * 0.5;
            const ci = cn * (PALETTE.length - 1);
            const ci0 = Math.floor(ci);
            const ci1 = Math.min(ci0 + 1, PALETTE.length - 1);
            lerpColor(PALETTE[ci0], PALETTE[ci1], ci - ci0);
            mirrorColAttr.setXYZ(i, tempCol.r, tempCol.g, tempCol.b);
          }
          mirrorPosAttr.needsUpdate = true;
          mirrorColAttr.needsUpdate = true;
          geoMirror.computeVertexNormals();

        }

        // Offset trunks to meet at y = 0: main tree rises, mirror drops
        solid.position.y       =  0.65 * morphT;
        solidMirror.position.y = -0.65 * mirrorMorphT;

        // Orbit lights — slow down when tree is present
        orbitLights.forEach((light, idx) => {
          const speed = (0.28 + idx * 0.12) * (1 - morphT * 0.7);
          const phase = (idx * Math.PI * 2) / orbitLights.length;
          const a = t * speed + phase;
          light.position.set(
            Math.cos(a) * 2.2,
            Math.sin(a * 0.8 + idx) * 1.8,
            Math.sin(a) * 2.2 + 0.5,
          );
        });

        // Auto-rotation — pauses while user drags, x springs back to level
        if (autoRotate) {
          group.rotation.y += 0.0006 * (1 - morphT * 0.85);
          group.rotation.x += (0 - group.rotation.x) * 0.02;
        }

        renderer.render(scene, camera);
      }());

      requestAnimationFrame(sizeRenderer);
      new ResizeObserver(sizeRenderer).observe(container);
    </script>

    <script>
      document.querySelectorAll('.tile, .spotlight').forEach(el => {
        const overlay = document.createElement('div');
        overlay.style.cssText = [
          'position:absolute',
          'inset:0',
          'pointer-events:none',
          'border-radius:inherit',
          'opacity:0',
          'transition:opacity 0.35s ease',
          'z-index:10',
        ].join(';');
        el.appendChild(overlay);

        el.addEventListener('mousemove', e => {
          const { left, top } = el.getBoundingClientRect();
          const x = e.clientX - left;
          const y = e.clientY - top;
          overlay.style.background = `radial-gradient(circle 120px at ${x}px ${y}px, rgba(255,255,255,0.025), transparent 70%)`;
          overlay.style.opacity = '1';
        });

        el.addEventListener('mouseleave', () => {
          overlay.style.opacity = '0';
        });
      });
    </script>
  </body>
</html>
